- block:

    ###################################################################
    # 1. Match Region + Env in Env.csv
    ###################################################################
    - name: Match Region+Env in Env.csv
      set_fact:
        selected_block: "{{ item.Block }}"
      loop: "{{ env_data }}"
      when: item.RegionCode == req.RegionCode and item.Env == req.Env

    - fail:
        msg: "No matching block found for {{ req.RegionCode }}-{{ req.Env }}"
      when: selected_block is not defined

    ###################################################################
    # 2. CALCULATE NEXT AVAILABLE CIDR
    ###################################################################
    - name: Calculate CIDR
      script: "{{ calc_script }} {{ selected_block }} {{ req.SubnetSize }} {{ subnet_csv }}"
      register: calc

    - fail:
        msg: "NO free subnet available in block {{ selected_block }}"
      when: calc.stdout == "NO_AVAILABLE_SUBNET"

    - set_fact:
        new_cidr: "{{ calc.stdout | trim }}"
        cidr_exists: false

    ###################################################################
    # 3. Generate Subnet Name (auto-increment last 3 digits)
    ###################################################################
    - name: Filter existing names
      set_fact:
        matched_names: >-
          {{
            subnet_data
            | map(attribute='SubnetName')
            | select('match',
              '^(?:' ~ req.RegionCode|lower ~ '-' ~ req.Env|lower ~ '-' ~ req.Solution|lower ~ '-).*-(\\d{3})-snt$'
            )
            | list
          }}

    - name: Extract numbers
      set_fact:
        number_list: >-
          {{
            matched_names
            | map('regex_search', '(\\d{3})(?=-snt$)')
            | reject('equalto', None)
            | map('int')
            | list
          }}

    - name: Determine next_number
      set_fact:
        next_number: "{{ '%03d' | format((number_list | max(default=0)) + 1) }}"

    - name: Build final SubnetName
      set_fact:
        SubnetName: "{{ (
            req.RegionCode|lower ~ '-' ~
            req.Env|lower ~ '-' ~
            req.Solution|lower ~ '-' ~
            next_number ~ '-snt'
        ) | regex_replace('[^a-z0-9-]', '') | truncate(63, True, '') }}"

    ###################################################################
    # 4. APPEND TO Subnet.csv
    ###################################################################
    - name: Update Subnet.csv
      lineinfile:
        path: "{{ subnet_csv }}"
        insertafter: EOF
        line: "{{ req.RegionCode }},{{ req.Env }},{{ new_cidr }},{{ SubnetName }},NetworkTeam,Created,{{ req.Comments | default('NA') }}"

    ###################################################################
    # 5. CREATE SUBNET IN GCP
    ###################################################################
    - name: Create subnet
      google.cloud.gcp_compute_subnetwork:
        name: "{{ SubnetName }}"
        project: "{{ gcp_project }}"
        region: "{{ region_map[req.RegionCode] }}"
        ip_cidr_range: "{{ new_cidr }}"
        network:
          selfLink: "https://www.googleapis.com/compute/v1/projects/{{ gcp_project }}/global/networks/{{ req.VPC }}"
        auth_kind: serviceaccount
        state: present
      register: subnet_creation_result

    - debug:
        msg: "Created {{ new_cidr }} → {{ SubnetName }} in region {{ region_map[req.RegionCode] }}"

    ###################################################################
    # 6. SAVE RESULT FOR SUMMARY REPORT (EMAIL)
    ###################################################################
    - name: Store result for HTML summary
      set_fact:
        subnet_results: "{{ subnet_results + [ {
            'Region': req.RegionCode,
            'Env': req.Env,
            'Solution': req.Solution,
            'CIDR': new_cidr,
            'SubnetName': SubnetName,
            'Status': (
                'Already Exists' if cidr_exists else
                'Created' if (subnet_creation_result.changed | default(false)) else
                'Failed'
            ),
            'Color': (
                '#FFA500' if cidr_exists else
                '#008000' if (subnet_creation_result.changed | default(false)) else
                '#FF0000'
            ),
            'Comments': req.Comments | default('N/A')
        } ] }}"

  ###################################################################
  # RESCUE BLOCK — CIDR NOT FOUND / ERROR
  ###################################################################
  rescue:
    - debug:
        msg: "⚠️ Skipping subnet for {{ req.RegionCode }}-{{ req.Env }} due to error"

    - name: Store FAILED result in summary
      set_fact:
        subnet_results: "{{ subnet_results + [ {
            'Region': req.RegionCode,
            'Env': req.Env,
            'Solution': req.Solution,
            'CIDR': 'N/A',
            'SubnetName': 'N/A',
            'Status': 'Failed',
            'Color': '#FF0000',
            'Comments': req.Comments | default('Error')
        } ] }}"

  ###################################################################
  # ALWAYS — CLEAN VARIABLES
  ###################################################################
  always:
    - set_fact:
        selected_block: null
        new_cidr: null
        SubnetName: null
        matched_names: []
