---
# subnet_unit.yml
# Handles ONE subnet request with auto-retry for GCP conflicts

- name: Match Region+Env in Env.csv
  set_fact:
    selected_block: "{{ item.Block }}"
  when: item.RegionCode == req.RegionCode and item.Env == req.Env
  loop: "{{ env_data }}"

- name: Fail if block missing
  fail:
    msg: "No matching block found for Region={{ req.RegionCode }} Env={{ req.Env }}"
  when: selected_block is not defined

# -------------------------------------------------------------------
#  STEP 1: Calculate new CIDR using new GCP-aware calc script
# -------------------------------------------------------------------
- name: Calculate next available CIDR (GCP-aware)
  command: >
    python3 {{ playbook_dir }}/scripts/calc_next_subnet.py
    {{ selected_block }}
    {{ req.SubnetSize }}
    {{ playbook_dir }}/data/Subnet.csv
    {{ gcp_project }}
    {{ region_map[req.RegionCode] }}
  register: calc

- name: Stop if no CIDR available
  fail:
    msg: "No available subnet left in block {{ selected_block }}"
  when: calc.stdout == "NO_AVAILABLE_SUBNET"

- set_fact:
    new_cidr: "{{ calc.stdout }}"

# -------------------------------------------------------------------
#  STEP 2: Build SubnetName (auto-numbering)
# -------------------------------------------------------------------
- name: Filter existing names from CSV
  set_fact:
    matched_names: "{{ subnet_data
                       | selectattr('RegionCode','equalto',req.RegionCode)
                       | selectattr('Env','equalto',req.Env)
                       | selectattr('SubnetName','search', req.Solution)
                       | map(attribute='SubnetName') | list }}"

- name: Extract numbers from names
  set_fact:
    number_list: "{{ matched_names | map('regex_search', '\\d+') | select('!=', None) | map('int') | list }}"

- name: Determine last_number
  set_fact:
    last_number: "{{ (number_list | max) | default(0) }}"

- name: Determine next_number
  set_fact:
    next_number: "{{ '%03d' % (last_number + 1) }}"

- name: Build final Subnet Name
  set_fact:
    SubnetName: "{{ req.RegionCode | lower }}-{{ req.Env }}-{{ req.Solution }}-{{ next_number }}-snt"

# -------------------------------------------------------------------
#  STEP 3: Try subnet creation — Retry if GCP conflict
# -------------------------------------------------------------------
- name: Create subnet in GCP
  block:
    - name: Create subnet
      google.cloud.gcp_compute_subnetwork:
        auth_kind: serviceaccount
        service_account_file: "{{ gcp_sa_file }}"
        project: "{{ gcp_project }}"
        region: "{{ region_map[req.RegionCode] }}"
        name: "{{ SubnetName }}"
        ip_cidr_range: "{{ new_cidr }}"
        network:
          selfLink: "{{ vpc_selflink }}"
        state: present
      register: create_out

  rescue:
    - debug:
        msg: "❗ CIDR or SubnetName conflict in GCP → Retrying with next CIDR..."

    # Calculate new CIDR
    - command: >
        python3 {{ playbook_dir }}/scripts/calc_next_subnet.py
        {{ selected_block }}
        {{ req.SubnetSize }}
        {{ playbook_dir }}/data/Subnet.csv
        {{ gcp_project }}
        {{ region_map[req.RegionCode] }}
      register: calc_retry

    - set_fact:
        new_cidr: "{{ calc_retry.stdout }}"

    - include_tasks: subnet_unit.yml   # retry same request

    - meta: end_play

# -------------------------------------------------------------------
#  STEP 4: Update CSV after successful creation
# -------------------------------------------------------------------
- name: Update Subnet.csv
  lineinfile:
    path: "{{ playbook_dir }}/data/Subnet.csv"
    insertafter: EOF
    line: "{{ req.RegionCode }},{{ req.Env }},{{ new_cidr }},{{ SubnetName }},NetworkTeam,Created,{{ req.Comments }}"
