---
- block:

    - name: Match Region+Env in Env.csv
      set_fact:
        selected_block: "{{ item.Block }}"
      loop: "{{ env_data }}"
      when: item.RegionCode == req.RegionCode and item.Env == req.Env

    - fail:
        msg: "No matching block found for {{ req.RegionCode }}-{{ req.Env }}"
      when: selected_block is not defined

    - name: Calculate CIDR
      script: "{{ calc_script }} {{ selected_block }} {{ req.SubnetSize }} {{ subnet_csv }}"
      register: calc

    - fail:
        msg: "NO free subnet available in block {{ selected_block }}"
      when: calc.stdout == "NO_AVAILABLE_SUBNET"

    - set_fact:
        new_cidr: "{{ calc.stdout | trim }}"
        cidr_exists: false

    #####################################################################
    # GENERATE NEXT SUBNET NAME
    #####################################################################

    - name: Filter existing matching subnet names
      set_fact:
        matched_names: >-
          {{
            subnet_data
            | selectattr("RegionCode", "equalto", req.RegionCode)
            | selectattr("Env", "equalto", req.Env)
            | selectattr("SubnetName", "search", req.Solution | lower)
            | map(attribute="SubnetName")
            | list
          }}

    - name: Extract numbers
      set_fact:
        number_list: >-
          {{
            matched_names
            | map('regex_search', '(\d{3})(?=-snt$)')
            | reject('equalto', None)
            | map('int')
            | list
          }}

    - name: Determine next_number (AWX safe)
      set_fact:
        next_number: >-
          {{
            '%03d' | format(
              (
                (number_list | length > 0) | ternary(number_list | max, 0)
              ) + 1
            )
          }}

    - name: Build final SubnetName
      set_fact:
        SubnetName: "{{ (
            req.RegionCode|lower ~ '-' ~
            req.Env|lower ~ '-' ~
            req.Solution|lower ~ '-' ~
            next_number ~ '-snt'
          ) | regex_replace('[^a-z0-9-]', '') | truncate(63, True, '') }}"

    #####################################################################
    # UPDATE CSV FILE
    #####################################################################

    - name: Append new subnet entry to Subnet.csv
      lineinfile:
        path: "{{ subnet_csv }}"
        insertafter: EOF
        line: "{{ req.RegionCode }},{{ req.Env }},{{ new_cidr }},{{ SubnetName }},NetworkTeam,Created,{{ req.Comments | default('NA') }}"

    #####################################################################
    # CREATE SUBNET IN GCP
    #####################################################################

    - name: Create subnet
      google.cloud.gcp_compute_subnetwork:
        name: "{{ SubnetName }}"
        project: "{{ gcp_project }}"
        region: "{{ region_map[req.RegionCode] }}"
        ip_cidr_range: "{{ new_cidr }}"
        network:
          selfLink: "https://www.googleapis.com/compute/v1/projects/{{ gcp_project }}/global/networks/{{ req.VPC }}"
        auth_kind: serviceaccount
        state: present
      register: subnet_creation_result

    - debug:
        msg: "Created {{ new_cidr }} → {{ SubnetName }}"

    - name: Store SUCCESS result
      set_fact:
        subnet_results: "{{ subnet_results + [{
          'Region': req.RegionCode,
          'Env': req.Env,
          'Solution': req.Solution,
          'SubnetName': SubnetName,
          'CIDR': new_cidr,
          'Status': 'Created',
          'Color': '#008000'
        }] }}"

  rescue:

    - debug:
        msg: "⚠️ Skipping subnet for {{ req.RegionCode }}-{{ req.Env }} due to error"

    - name: Store FAILED result
      set_fact:
        subnet_results: "{{ subnet_results + [{
          'Region': req.RegionCode,
          'Env': req.Env,
          'Solution': req.Solution,
          'SubnetName': 'N/A',
          'CIDR': 'N/A',
          'Status': 'Failed',
          'Color': '#FF0000'
        }] }}"

  always:
    - set_fact:
        selected_block: null
        new_cidr: null
        SubnetName: null
