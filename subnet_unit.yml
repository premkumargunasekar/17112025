# subnet_unit.yml
---

# ------------------------------
# 1. Detect correct block
# ------------------------------
- name: Select matching block from Env.csv
  set_fact:
    selected_block: "{{ item.Block }}"
  loop: "{{ env_data }}"
  when: item.RegionCode == req.RegionCode and item.Env == req.Env

- name: Fail if block missing
  fail:
    msg: "No matching block found in Env.csv for Region {{ req.RegionCode }} and Env {{ req.Env }}"
  when: selected_block is not defined


# ------------------------------
# 2. Calculate next CIDR (GCP-aware)
# ------------------------------
- name: Calculate next available CIDR (GCP-aware)
  command:
    argv:
      - python3
      - "{{ calc_script }}"
      - "{{ selected_block }}"
      - "{{ req.SubnetSize }}"
      - "{{ subnet_csv }}"
      - "{{ gcp_project }}"
      - "{{ region_map[req.RegionCode] }}"
  register: calc
  changed_when: false

- name: Stop if no CIDR available
  fail:
    msg: "No free CIDR available in block {{ selected_block }}"
  when: calc.stdout == "NO_AVAILABLE_SUBNET"

- set_fact:
    new_cidr: "{{ calc.stdout }}"


# ------------------------------
# 3. Filtering existing subnet names for numbering logic
# ------------------------------
- name: Filter existing names from CSV
  set_fact:
    matched_names: >-
      {{ subnet_data
         | selectattr('SubnetName', 'search', req.RegionCode | lower ~ '-' ~ req.Env | lower ~ '-' ~ req.Solution | lower)
         | map(attribute='SubnetName')
         | list }}


# ------------------------------
# 4. Extract numbers robustly (SAFE)
# ------------------------------
- name: Extract numbers (safe & ignore failures)
  set_fact:
    number_list: >-
      {{ matched_names
        | map('regex_search', '.*-(\\d+)-snt$')
        | map('default', '')
        | map('int', default=0)
        | list }}

# ------------------------------
# 5. Pick the next number
# ------------------------------
- name: Determine last_number
  set_fact:
    last_number: "{{ number_list | max if number_list|length > 0 else 0 }}"

- name: Determine next_number
  set_fact:
    next_number: "{{ '%03d' % (last_number + 1) }}"


# ------------------------------
# 6. Build final subnet name
# ------------------------------
- name: Build final SubnetName
  set_fact:
    SubnetName: "{{ req.RegionCode | lower }}-{{ req.Env | lower }}-{{ req.Solution | lower }}-{{ next_number }}-snt"


# ------------------------------
# 7. Update CSV
# ------------------------------
- name: Update Subnet.csv
  lineinfile:
    path: "{{ subnet_csv }}"
    insertafter: EOF
    line: "{{ req.RegionCode }},{{ req.Env }},{{ new_cidr }},{{ SubnetName }},NetworkTeam,Created,{{ req.Comments }}"
  when: new_cidr is defined


# ------------------------------
# 8. Create subnet in GCP
# ------------------------------
- name: Create subnet
  google.cloud.gcp_compute_subnetwork:
    name: "{{ SubnetName }}"
    ip_cidr_range: "{{ new_cidr }}"
    region: "{{ region_map[req.RegionCode] }}"
    network:
      selfLink: "https://www.googleapis.com/compute/v1/projects/{{ gcp_project }}/global/networks/{{ req.VPC }}"
    project: "{{ gcp_project }}"
    auth_kind: serviceaccount
    service_account_file: "{{ service_account_file }}"
  register: result
  ignore_errors: yes

- debug:
    msg: "Skipping subnet for {{ req.RegionCode }}-{{ req.Env }} due to GCP error: {{ result.msg }}"
  when: result.failed

- set_fact:
    new_cidr: null
    selected_block: null
